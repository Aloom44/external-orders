<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة طلب جديد - Rumex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .order-card {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .card-header h1 {
            margin: 0;
            font-size: 28px;
        }
        .card-body {
            padding: 30px;
        }
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            padding: 12px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .section-title {
            background: #f8f9fa;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 25px 0 15px 0;
            font-weight: 700;
            color: #667eea;
        }
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            color: white;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .product-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .btn-add-product {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .btn-remove-product {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        .price-summary {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }
        .price-row.total {
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
            border-top: 2px solid #667eea;
            padding-top: 15px;
            margin-top: 10px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .success-message {
            display: none;
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }
        .success-message h2 {
            color: #155724;
            margin-bottom: 15px;
        }
        .order-code {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin: 15px 0;
        }
        .error-message {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            color: #721c24;
            margin: 20px 0;
            display: none;
        }
        .user-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .user-info strong {
            color: #856404;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="order-card">
        <div class="card-header">
            <h1><i class="fas fa-box"></i> إضافة طلب جديد</h1>
            <p style="margin: 10px 0 0 0; font-size: 14px;">Rumex - نظام إدارة الطلبات</p>
        </div>

        <div class="card-body">
            <!-- معلومات المستخدم -->
            <div class="user-info" id="userInfo">
                <i class="fas fa-user-circle" style="font-size: 24px;"></i>
                <strong id="userName">جاري التحميل...</strong>
            </div>

            <!-- رسالة الخطأ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- رسالة النجاح -->
            <div class="success-message" id="successMessage">
                <h2><i class="fas fa-check-circle"></i> تم إضافة الطلب بنجاح!</h2>
                <p>كود الطلب:</p>
                <div class="order-code" id="orderCode">---</div>
                <button class="btn btn-primary mt-3" onclick="location.reload()">إضافة طلب جديد</button>
            </div>

            <!-- فورم الطلب -->
            <form id="orderForm">
                <!-- بيانات العميل -->
                <div class="section-title">
                    <i class="fas fa-user"></i> بيانات العميل
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">اسم العميل *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">رقم الهاتف *</label>
                        <input type="tel" class="form-control" id="phoneNumber" pattern="[0-9]{11}" placeholder="01xxxxxxxxx" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">المحافظة *</label>
                        <select class="form-select" id="province" required>
                            <option value="">اختر المحافظة</option>
                            <option value="القاهرة">القاهرة</option>
                            <option value="الجيزة">الجيزة</option>
                            <option value="الإسكندرية">الإسكندرية</option>
                            <option value="الدقهلية">الدقهلية</option>
                            <option value="الشرقية">الشرقية</option>
                            <option value="المنوفية">المنوفية</option>
                            <option value="القليوبية">القليوبية</option>
                            <option value="البحيرة">البحيرة</option>
                            <option value="الغربية">الغربية</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">رقم هاتف ثانوي (اختياري)</label>
                        <input type="tel" class="form-control" id="secondaryPhone" pattern="[0-9]{11}">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">العنوان التفصيلي *</label>
                    <textarea class="form-control" id="addressDetails" rows="2" required></textarea>
                </div>

                <!-- المنتجات -->
                <div class="section-title">
                    <i class="fas fa-shopping-cart"></i> المنتجات
                </div>

                <div id="productsContainer">
                    <div class="product-row" data-product-index="0">
                        <div class="row align-items-end">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">اسم المنتج *</label>
                                <select class="form-control product-select" required onchange="loadVariants(this)">
                                    <option value="">-- اختر المنتج --</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">المقاس/الحجم *</label>
                                <select class="form-control variant-select" required onchange="updatePrice(this)">
                                    <option value="">-- اختر المقاس --</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">الكمية *</label>
                                <input type="number" class="form-control product-quantity" min="1" value="1" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">السعر</label>
                                <input type="number" class="form-control product-price" min="0" step="0.01" required readonly>
                            </div>
                            <div class="col-md-1 mb-2">
                                <button type="button" class="btn-remove-product" onclick="removeProduct(this)" style="display:none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-add-product" onclick="addProduct()">
                    <i class="fas fa-plus"></i> إضافة منتج آخر
                </button>

                <!-- الأسعار والخصومات -->
                <div class="section-title">
                    <i class="fas fa-calculator"></i> التكاليف
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">مصاريف الشحن</label>
                        <input type="number" class="form-control" id="shippingCost" min="0" step="0.01" value="0">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">الخصم</label>
                        <input type="number" class="form-control" id="discount" min="0" step="0.01" value="0">
                    </div>
                </div>

                <!-- ملخص الأسعار -->
                <div class="price-summary">
                    <div class="price-row">
                        <span>مجموع المنتجات:</span>
                        <strong><span id="productsTotal">0.00</span> جنيه</strong>
                    </div>
                    <div class="price-row">
                        <span>الشحن:</span>
                        <strong><span id="shippingTotal">0.00</span> جنيه</strong>
                    </div>
                    <div class="price-row">
                        <span>الخصم:</span>
                        <strong style="color: #dc3545;">-<span id="discountTotal">0.00</span> جنيه</strong>
                    </div>
                    <div class="price-row total">
                        <span>الإجمالي:</span>
                        <span id="grandTotal">0.00 جنيه</span>
                    </div>
                </div>

                <!-- معلومات إضافية -->
                <div class="section-title">
                    <i class="fas fa-info-circle"></i> معلومات إضافية
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">اسم الصفحة</label>
                        <input type="text" class="form-control" id="pageName" placeholder="مثال: دكتور نسرين">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">عميل VIP</label>
                        <select class="form-select" id="isVip">
                            <option value="false">لا</option>
                            <option value="true">نعم</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ملاحظات</label>
                    <textarea class="form-control" id="notes" rows="3" placeholder="أي ملاحظات إضافية..."></textarea>
                </div>

                <!-- زر الإرسال -->
                <button type="submit" class="btn-submit">
                    <i class="fas fa-paper-plane"></i> إرسال الطلب
                </button>

                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري الإرسال...</span>
                    </div>
                    <p class="mt-2">جاري إرسال الطلب...</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCd3epuBRvwtz6w-12C3uUcTZNaPeklD-I",
            authDomain: "rumex-orders.firebaseapp.com",
            projectId: "rumex-orders",
            storageBucket: "rumex-orders.firebasestorage.app",
            messagingSenderId: "575319007618",
            appId: "1:575319007618:web:b0efe0ddf706722cf66f9b",
            measurementId: "G-8LDPSCNRC0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Get API Key from URL
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('key');
        
        // تخزين المنتجات
        let productsData = [];

        if (!apiKey) {
            document.getElementById('errorMessage').textContent = '⚠️ رابط غير صالح. يرجى استخدام الرابط الذي تم إرساله لك.';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('orderForm').style.display = 'none';
        } else {
            document.getElementById('userName').textContent = `مستخدم: ${apiKey.substring(0, 8)}...`;
            // جلب المنتجات من الـ API
            loadProducts();
        }
        
        // جلب المنتجات من الـ API
        async function loadProducts() {
            try {
                const response = await fetch('http://localhost:8000/api/external/products/');
                const data = await response.json();
                
                if (data.success) {
                    productsData = data.products;
                    updateProductSelects();
                } else {
                    console.error('Error loading products:', data.error);
                }
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }
        
        // تحديث قوائم المنتجات
        function updateProductSelects() {
            document.querySelectorAll('.product-select').forEach(select => {
                select.innerHTML = '<option value="">-- اختر المنتج --</option>';
                productsData.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    option.dataset.variants = JSON.stringify(product.variants);
                    select.appendChild(option);
                });
            });
        }
        
        // تحميل المتغيرات عند اختيار منتج
        window.loadVariants = function(selectElement) {
            const row = selectElement.closest('.product-row');
            const variantSelect = row.querySelector('.variant-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            variantSelect.innerHTML = '<option value="">-- اختر المقاس --</option>';
            
            if (selectedOption.dataset.variants) {
                const variants = JSON.parse(selectedOption.dataset.variants);
                variants.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant.id;
                    option.textContent = variant.display_name;
                    option.dataset.price = variant.price;
                    option.dataset.stock = variant.quantity;
                    variantSelect.appendChild(option);
                });
            }
            
            // إعادة تعيين السعر
            row.querySelector('.product-price').value = '';
            calculateTotal();
        }
        
        // تحديث السعر عند اختيار المتغير
        window.updatePrice = function(selectElement) {
            const row = selectElement.closest('.product-row');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (selectedOption.dataset.price) {
                row.querySelector('.product-price').value = selectedOption.dataset.price;
                calculateTotal();
            }
        }

        // حساب الإجمالي
        function calculateTotal() {
            let productsTotal = 0;
            document.querySelectorAll('.product-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.product-price').value) || 0;
                productsTotal += quantity * price;
            });

            const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const grandTotal = productsTotal + shipping - discount;

            document.getElementById('productsTotal').textContent = productsTotal.toFixed(2);
            document.getElementById('shippingTotal').textContent = shipping.toFixed(2);
            document.getElementById('discountTotal').textContent = discount.toFixed(2);
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2) + ' جنيه';
        }

        // إضافة event listeners للحساب التلقائي
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('product-quantity') || 
                e.target.classList.contains('product-price') ||
                e.target.id === 'shippingCost' ||
                e.target.id === 'discount') {
                calculateTotal();
            }
        });

        // إرسال الطلب
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // جمع بيانات المنتجات
            const products = [];
            document.querySelectorAll('.product-row').forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const variantSelect = row.querySelector('.variant-select');
                const productName = productSelect.options[productSelect.selectedIndex].text;
                const variantName = variantSelect.options[variantSelect.selectedIndex].text;
                const quantity = parseInt(row.querySelector('.product-quantity').value);
                const price = parseFloat(row.querySelector('.product-price').value);

                products.push({
                    product_id: productSelect.value,
                    variant_id: variantSelect.value,
                    name: productName,
                    size: variantName,
                    quantity: quantity,
                    price: price
                });
            });

                if (name && quantity && price) {
                    products.push({
                        product_name: name,
                        size: size || '',
                        quantity: quantity,
                        unit_price: price,
                        total: quantity * price
                    });
                }
            });

            // حساب الإجمالي
            const productsTotal = products.reduce((sum, p) => sum + p.total, 0);
            const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const grandTotal = productsTotal + shipping - discount;

            // بيانات الطلب
            const orderData = {
                // بيانات العميل
                customer_name: document.getElementById('customerName').value,
                phone_number: document.getElementById('phoneNumber').value,
                secondary_phone: document.getElementById('secondaryPhone').value || '',
                province: document.getElementById('province').value,
                address_details: document.getElementById('addressDetails').value,
                
                // المنتجات
                products: products,
                
                // الأسعار
                total_products: productsTotal,
                shipping_cost: shipping,
                discount: discount,
                total_amount: grandTotal,
                
                // معلومات إضافية
                notes: document.getElementById('notes').value || '',
                page_name: document.getElementById('pageName').value || '',
                is_vip: document.getElementById('isVip').value === 'true',
                
                // معلومات النظام
                api_key: apiKey,
                status: 'pending',
                order_code: null,
                created_at: serverTimestamp(),
                processed: false
            };

            try {
                // إخفاء الفورم وعرض Loading
                document.getElementById('orderForm').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                // إرسال لـ Firebase
                const docRef = await addDoc(collection(db, 'orders'), orderData);
                console.log('Order sent with ID:', docRef.id);

                // الانتظار لحظة للحصول على كود الطلب من السيستم
                // TODO: Add real-time listener for order code
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('orderCode').textContent = 'في انتظار الكود...';
                }, 1000);

            } catch (error) {
                console.error('Error adding order:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('orderForm').style.display = 'block';
                document.getElementById('errorMessage').textContent = '❌ حدث خطأ: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        // Make functions global
        window.calculateTotal = calculateTotal;
    </script>

    <script>
        // إضافة منتج جديد
        function addProduct() {
            const container = document.getElementById('productsContainer');
            const index = container.children.length;
            
            const productRow = document.createElement('div');
            productRow.className = 'product-row';
            productRow.setAttribute('data-product-index', index);
            productRow.innerHTML = `
                <div class="row align-items-end">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">اسم المنتج *</label>
                        <select class="form-control product-select" required onchange="loadVariants(this)">
                            <option value="">-- اختر المنتج --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">المقاس/الحجم *</label>
                        <select class="form-control variant-select" required onchange="updatePrice(this)">
                            <option value="">-- اختر المقاس --</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">الكمية *</label>
                        <input type="number" class="form-control product-quantity" min="1" value="1" required onchange="calculateTotal()">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">السعر</label>
                        <input type="number" class="form-control product-price" min="0" step="0.01" required readonly>
                    </div>
                    <div class="col-md-1 mb-2">
                        <button type="button" class="btn-remove-product" onclick="removeProduct(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(productRow);
            updateProductSelects(); // تحديث قائمة المنتجات في الصف الجديد
            updateRemoveButtons();
        }

        // حذف منتج
        function removeProduct(button) {
            button.closest('.product-row').remove();
            updateRemoveButtons();
            calculateTotal();
        }

        // تحديث أزرار الحذف
        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.product-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.btn-remove-product');
                if (rows.length > 1) {
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
