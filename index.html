<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة طلب جديد - Logexa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: #e8eaed;
            min-height: 100vh;
            font-family: 'Cairo', 'Segoe UI', sans-serif;
            padding-top: 70px;
        }
        
        /* Header */
        .app-header {
            background: #2d5f3f;
            color: white;
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .app-header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .app-header h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }
        .app-header .logo-icon {
            font-size: 28px;
        }
        
        /* Main Card */
        .order-card {
            max-width: 600px;
            margin: 15px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .card-title {
            padding: 20px 20px 20px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        .card-title h2 {
            font-size: 20px;
            font-weight: 700;
            color: #2d5f3f;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-body {
            padding: 20px 20px 20px 15px;
        }
        
        /* Form Elements */
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 6px;
            font-size: 13px;
            display: block;
        }
        .form-control, .form-select {
            border-radius: 6px;
            border: 1.5px solid #dee2e6;
            padding: 10px 12px;
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
        }
        .form-control:focus, .form-select:focus {
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
            outline: none;
        }
        
        /* Section Dividers */
        .section-title {
            padding: 12px 0 8px 0;
            margin: 18px 0 12px 0;
            font-weight: 700;
            color: #2d5f3f;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        
        /* Buttons */
        .btn-submit {
            background: #D4AF37;
            border: none;
            padding: 14px 30px;
            font-size: 17px;
            font-weight: 700;
            border-radius: 8px;
            color: #2d5f3f;
            width: 100%;
            margin-top: 25px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .btn-submit:hover {
            background: #2d5f3f;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 95, 63, 0.3);
        }
        .btn-submit:disabled {
            background: #adb5bd;
            color: white;
            cursor: not-allowed;
            transform: none;
        }
        
        .product-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e9ecef;
        }
        .btn-add-product {
            background: #D4AF37;
            color: #2d5f3f;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
        }
        .btn-add-product:hover {
            background: #2d5f3f;
            color: white;
        }
        .btn-remove-product {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-remove-product:hover {
            background: #c82333;
        }
        
        /* Price Summary */
        .price-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1.5px solid #dee2e6;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
            color: #495057;
        }
        .price-row.total {
            font-size: 20px;
            font-weight: 700;
            color: #2d5f3f;
            border-top: 2px solid #D4AF37;
            padding-top: 15px;
            margin-top: 10px;
        }
        
        /* Loading & Messages */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        .loading i {
            font-size: 40px;
            color: #D4AF37;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            display: none;
            background: #d1f2eb;
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        .success-message h2 {
            color: #2d5f3f;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 700;
        }
        .order-code {
            font-size: 32px;
            font-weight: 700;
            color: #D4AF37;
            margin: 15px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .error-message {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 12px;
            padding: 20px;
            color: #721c24;
            margin: 20px 0;
            display: none;
            font-size: 15px;
        }
        .user-info {
            background: #e7f5ee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 1.5px solid #2d5f3f;
        }
        .user-info strong {
            color: #2d5f3f;
            font-size: 16px;
            font-weight: 700;
        }
        .user-info i {
            font-size: 24px;
            color: #D4AF37;
            margin-left: 8px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding-top: 70px;
            }
            .app-header {
                padding: 15px 0;
            }
            .app-header h1 {
                font-size: 20px;
            }
            .order-card {
                margin: 10px;
            }
            .card-title {
                padding: 20px;
            }
            .card-body {
                padding: 20px;
            }
            .form-label {
                font-size: 12px;
                margin-bottom: 3px;
            }
            .form-control, .form-select {
                padding: 6px 8px;
                font-size: 13px;
            }
            .section-title {
                padding: 6px 10px;
                font-size: 13px;
                margin: 10px 0 8px 0;
            }
            .product-row {
                padding: 8px;
                margin-bottom: 6px;
            }
            .btn-submit {
                padding: 10px 20px;
                font-size: 15px;
            }
            .price-row {
                font-size: 13px;
            }
            .price-row.total {
                font-size: 16px;
            }
            .mb-3 {
                margin-bottom: 0.75rem !important;
            }
            .row {
                margin-right: -5px;
                margin-left: -5px;
            }
            .row > * {
                padding-right: 5px;
                padding-left: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- App Header -->
    <div class="app-header">
        <div class="container">
            <i class='bx bx-package logo-icon'></i>
            <h1>Logexa - نظام إدارة الطلبات</h1>
        </div>
    </div>

    <div class="order-card">
        <div class="card-title">
            <h2>
                <i class='bx bx-shopping-bag'></i>
                إضافة طلب جديد
            </h2>
        </div>

        <div class="card-body">
            <!-- معلومات المستخدم -->
            <div class="user-info" id="userInfo">
                <i class='bx bx-user-circle'></i>
                <strong id="userName">جاري التحميل...</strong>
            </div>

            <!-- رسالة الخطأ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- رسالة النجاح -->
            <div class="success-message" id="successMessage">
                <h2><i class='bx bx-check-circle'></i> تم إضافة الطلب بنجاح!</h2>
                
                <div class="order-details" id="orderDetailsContainer" style="text-align: right; margin: 15px 0; padding: 20px; background: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1.5px solid #dee2e6;">
                    <div style="margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #D4AF37;">
                        <strong style="color: #8A1538; font-size: 14px;">تفاصيل الطلب</strong>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 6px 0; font-weight: 600; color: #8A1538; width: 35%;">كود الطلب:</td>
                            <td style="padding: 6px 0;">
                                <span id="orderCode" style="font-size: 16px; font-weight: bold; color: #D4AF37;">---</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 6px 0; font-weight: 600; color: #152F3E;">اسم العميل:</td>
                            <td style="padding: 6px 0;"><span id="orderCustomer">---</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 6px 0; font-weight: 600; color: #152F3E;">رقم الهاتف:</td>
                            <td style="padding: 6px 0; direction: ltr; text-align: right;"><span id="orderPhone">---</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 6px 0; font-weight: 600; color: #152F3E;">العنوان:</td>
                            <td style="padding: 6px 0;"><span id="orderFullAddress">---</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 6px 0; font-weight: 600; color: #152F3E;">المنتجات:</td>
                            <td style="padding: 6px 0;">
                                <span id="orderProductsList" style="font-size: 11px;">---</span>
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 6px 0; font-weight: 600; color: #152F3E;">قيمة الشحن:</td>
                            <td style="padding: 6px 0;">
                                <span id="orderShipping">---</span> جنيه
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 6px 0; font-weight: 600; color: #152F3E;">المبلغ الإجمالي:</td>
                            <td style="padding: 6px 0;">
                                <span id="orderTotal" style="color: #5fb091; font-size: 16px; font-weight: bold;">---</span> جنيه
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 6px 0; font-weight: 600; color: #152F3E;">اسم الصفحة:</td>
                            <td style="padding: 6px 0;"><span id="orderPageName">---</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 6px 0; font-weight: 600; color: #152F3E;">الموظف:</td>
                            <td style="padding: 6px 0;"><span id="orderEmployee">---</span></td>
                        </tr>
                    </table>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                    <button class="btn" onclick="copyOrderDetails(event)" style="background: #D4AF37; border: none; color: #2d5f3f; padding: 10px 25px; font-size: 15px; font-weight: 700; border-radius: 8px; transition: all 0.3s;">
                        <i class='bx bx-copy'></i> نسخ التفاصيل
                    </button>
                    <button class="btn" onclick="location.reload()" style="background: #2d5f3f; border: none; color: white; padding: 10px 25px; font-size: 15px; font-weight: 700; border-radius: 8px; transition: all 0.3s;">
                        <i class='bx bx-plus'></i> طلب جديد
                    </button>
                </div>
            </div>
            </div>

            <!-- فورم الطلب -->
            <form id="orderForm">
                <!-- بيانات العميل -->
                <div class="section-title">
                    <i class='bx bx-user'></i> بيانات العميل
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">اسم العميل *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">رقم الهاتف *</label>
                        <input type="tel" class="form-control" id="phoneNumber" pattern="[0-9]{11}" placeholder="01xxxxxxxxx" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">رقم هاتف ثانوي (اختياري)</label>
                        <input type="tel" class="form-control" id="secondaryPhone" pattern="[0-9]{11}" placeholder="01xxxxxxxxx">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">المحافظة *</label>
                        <select class="form-select" id="province" required>
                            <option value="">اختر المحافظة</option>
                            <option value="القاهرة">القاهرة</option>
                            <option value="الجيزة">الجيزة</option>
                            <option value="الإسكندرية">الإسكندرية</option>
                            <option value="الدقهلية">الدقهلية</option>
                            <option value="الشرقية">الشرقية</option>
                            <option value="المنوفية">المنوفية</option>
                            <option value="القليوبية">القليوبية</option>
                            <option value="البحيرة">البحيرة</option>
                            <option value="الغربية">الغربية</option>
                            <option value="كفر الشيخ">كفر الشيخ</option>
                            <option value="دمياط">دمياط</option>
                            <option value="بورسعيد">بورسعيد</option>
                            <option value="الإسماعيلية">الإسماعيلية</option>
                            <option value="السويس">السويس</option>
                            <option value="المنيا">المنيا</option>
                            <option value="بني سويف">بني سويف</option>
                            <option value="الفيوم">الفيوم</option>
                            <option value="أسيوط">أسيوط</option>
                            <option value="سوهاج">سوهاج</option>
                            <option value="قنا">قنا</option>
                            <option value="الأقصر">الأقصر</option>
                            <option value="أسوان">أسوان</option>
                            <option value="البحر الأحمر">البحر الأحمر</option>
                            <option value="الوادي الجديد">الوادي الجديد</option>
                            <option value="مطروح">مطروح</option>
                            <option value="شمال سيناء">شمال سيناء</option>
                            <option value="جنوب سيناء">جنوب سيناء</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">العنوان التفصيلي *</label>
                    <textarea class="form-control" id="addressDetails" rows="2" required></textarea>
                </div>

                <!-- المنتجات -->
                <div class="section-title">
                    <i class='bx bx-package'></i> المنتجات
                </div>

                <div id="productsContainer">
                    <div class="product-row" data-product-index="0">
                        <div class="row align-items-end">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">اسم المنتج *</label>
                                <select class="form-control product-select" required onchange="loadVariants(this)">
                                    <option value="">-- اختر المنتج --</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">المقاس/الحجم *</label>
                                <select class="form-control variant-select" required onchange="updatePrice(this)">
                                    <option value="">-- اختر المقاس --</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">الكمية *</label>
                                <input type="number" class="form-control product-quantity" min="1" value="1" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">السعر</label>
                                <input type="number" class="form-control product-price" min="0" step="0.01" required readonly>
                            </div>
                            <div class="col-md-1 mb-2">
                                <button type="button" class="btn-remove-product" onclick="removeProduct(this)" style="display:none;">
                                    <i class='bx bx-x'></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-add-product" onclick="addProduct()">
                    <i class='bx bx-plus'></i> إضافة منتج آخر
                </button>

                <!-- الأسعار والخصومات -->
                <div class="section-title">
                    <i class='bx bx-calculator'></i> التكاليف
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">مصاريف الشحن</label>
                        <input type="number" class="form-control" id="shippingCost" min="0" step="0.01" value="50">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">الخصم</label>
                        <input type="number" class="form-control" id="discount" min="0" step="0.01" value="0">
                    </div>
                </div>

                <!-- ملخص الأسعار -->
                <div class="price-summary">
                    <div class="price-row">
                        <span>مجموع المنتجات:</span>
                        <strong><span id="productsTotal">0.00</span> جنيه</strong>
                    </div>
                    <div class="price-row">
                        <span>الشحن:</span>
                        <strong><span id="shippingTotal">0.00</span> جنيه</strong>
                    </div>
                    <div class="price-row">
                        <span>الخصم:</span>
                        <strong style="color: #dc3545;">-<span id="discountTotal">0.00</span> جنيه</strong>
                    </div>
                    <div class="price-row total">
                        <span>الإجمالي:</span>
                        <span id="grandTotal">0.00 جنيه</span>
                    </div>
                </div>

                <!-- معلومات إضافية -->
                <div class="section-title">
                    <i class='bx bx-info-circle'></i> معلومات إضافية
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">اسم الصفحة</label>
                        <input type="text" class="form-control" id="pageName" placeholder="مثال: دكتور نسرين">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ملاحظات</label>
                    <textarea class="form-control" id="notes" rows="3" placeholder="أي ملاحظات إضافية..."></textarea>
                </div>

                <!-- زر الإرسال -->
                <button type="submit" class="btn-submit">
                    <i class='bx bx-send'></i> إرسال الطلب
                </button>

                <!-- Loading -->
                <div class="loading" id="loading">
                    <i class='bx bx-loader-alt'></i>
                    <p style="margin-top: 15px; font-size: 16px; color: #2d5f3f; font-weight: 600;">جاري إرسال الطلب...</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCd3epuBRvwtz6w-12C3uUcTZNaPeklD-I",
            authDomain: "rumex-orders.firebaseapp.com",
            projectId: "rumex-orders",
            storageBucket: "rumex-orders.firebasestorage.app",
            messagingSenderId: "575319007618",
            appId: "1:575319007618:web:b0efe0ddf706722cf66f9b",
            measurementId: "G-8LDPSCNRC0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Get API Key from URL - Make it global
        const urlParams = new URLSearchParams(window.location.search);
        window.apiKey = urlParams.get('key');
        const apiKey = window.apiKey;
        
        // تخزين المنتجات وبيانات الموظف
        let productsData = [];
        let employeeData = null;
        
        // تحديد API Base URL بناءً على البيئة - يجب تعريفه أولاً
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:8000' 
            : 'https://b3sem.store';
        
        console.log('API Base URL:', API_BASE_URL);

        if (!apiKey) {
            document.getElementById('errorMessage').textContent = '⚠️ رابط غير صالح. يرجى استخدام الرابط الذي تم إرساله لك.';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('orderForm').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
        } else {
            // التحقق من صحة API Key وجلب بيانات الموظف
            validateEmployee();
        }
        
        // التحقق من صحة الموظف
        async function validateEmployee() {
            try {
                console.log('Validating employee with API URL:', `${API_BASE_URL}/api/external/validate/?key=${window.apiKey}`);
                const response = await fetch(`${API_BASE_URL}/api/external/validate/?key=${window.apiKey}`);
                const data = await response.json();
                
                if (data.success) {
                    employeeData = data.employee;
                    document.getElementById('userName').innerHTML = `
                        <i class="fas fa-user-check" style="color: #28a745;"></i> 
                        ${employeeData.name} - ${employeeData.role}
                    `;
                    // جلب المنتجات بعد التحقق من الموظف
                    loadProducts();
                } else {
                    document.getElementById('errorMessage').textContent = '❌ ' + (data.error || 'مفتاح API غير صالح');
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('orderForm').style.display = 'none';
                    document.getElementById('userName').innerHTML = '<i class="fas fa-exclamation-triangle"></i> غير مصرح';
                }
            } catch (error) {
                console.error('Error validating employee:', error);
                document.getElementById('errorMessage').textContent = '❌ خطأ في التحقق من الهوية: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('orderForm').style.display = 'none';
            }
        }
        
        // جلب المنتجات من الـ API
        async function loadProducts() {
            try {
                console.log('loadProducts called');
                console.log('apiKey value:', window.apiKey);
                console.log('apiKey type:', typeof window.apiKey);
                console.log('API_BASE_URL:', API_BASE_URL);
                const url = `${API_BASE_URL}/api/external/products/?key=${window.apiKey}`;
                console.log('Loading products from:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    productsData = data.products;
                    updateProductSelects();
                } else {
                    console.error('Error loading products:', data.error);
                }
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }
        
        // تحديث قوائم المنتجات
        window.updateProductSelects = function updateProductSelects() {
            document.querySelectorAll('.product-select').forEach(select => {
                select.innerHTML = '<option value="">-- اختر المنتج --</option>';
                productsData.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    option.dataset.variants = JSON.stringify(product.variants);
                    select.appendChild(option);
                });
            });
        }
        
        // تحميل المتغيرات عند اختيار منتج
        window.loadVariants = function(selectElement) {
            const row = selectElement.closest('.product-row');
            const variantSelect = row.querySelector('.variant-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            variantSelect.innerHTML = '<option value="">-- اختر المقاس --</option>';
            
            if (selectedOption.dataset.variants) {
                const variants = JSON.parse(selectedOption.dataset.variants);
                variants.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant.id;
                    option.textContent = variant.display_name;
                    option.dataset.price = variant.price;
                    option.dataset.stock = variant.quantity;
                    variantSelect.appendChild(option);
                });
            }
            
            // إعادة تعيين السعر
            row.querySelector('.product-price').value = '';
            calculateTotal();
        }
        
        // تحديث السعر عند اختيار المتغير
        window.updatePrice = function(selectElement) {
            const row = selectElement.closest('.product-row');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (selectedOption.dataset.price) {
                row.querySelector('.product-price').value = selectedOption.dataset.price;
                calculateTotal();
            }
        }

        // حساب الإجمالي
        function calculateTotal() {
            let productsTotal = 0;
            document.querySelectorAll('.product-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.product-price').value) || 0;
                productsTotal += quantity * price;
            });

            const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const grandTotal = productsTotal + shipping - discount;

            document.getElementById('productsTotal').textContent = productsTotal.toFixed(2);
            document.getElementById('shippingTotal').textContent = shipping.toFixed(2);
            document.getElementById('discountTotal').textContent = discount.toFixed(2);
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2) + ' جنيه';
        }

        // إضافة event listeners للحساب التلقائي
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('product-quantity') || 
                e.target.classList.contains('product-price') ||
                e.target.id === 'shippingCost' ||
                e.target.id === 'discount') {
                calculateTotal();
            }
        });

        // إرسال الطلب
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // جمع بيانات المنتجات
            const products = [];
            let productsTotal = 0;
            
            document.querySelectorAll('.product-row').forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const variantSelect = row.querySelector('.variant-select');
                const productName = productSelect.options[productSelect.selectedIndex].text;
                const variantName = variantSelect.options[variantSelect.selectedIndex].text;
                const quantity = parseInt(row.querySelector('.product-quantity').value);
                const price = parseFloat(row.querySelector('.product-price').value);

                products.push({
                    product_id: productSelect.value,
                    variant_id: variantSelect.value,
                    name: productName,
                    size: variantName,
                    quantity: quantity,
                    price: price
                });
                
                productsTotal += quantity * price;
            });

            // حساب الإجمالي
            const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const grandTotal = productsTotal + shipping - discount;

            // بيانات الطلب
            const orderData = {
                // بيانات العميل
                customer_name: document.getElementById('customerName').value,
                phone_number: document.getElementById('phoneNumber').value,
                secondary_phone: document.getElementById('secondaryPhone').value || '',
                province: document.getElementById('province').value,
                address_details: document.getElementById('addressDetails').value,
                
                // المنتجات
                products: products,
                
                // الأسعار
                total_products: productsTotal,
                shipping_cost: shipping,
                discount: discount,
                total_amount: grandTotal,
                
                // معلومات إضافية
                notes: document.getElementById('notes').value || '',
                page_name: document.getElementById('pageName').value || '',
                
                // معلومات النظام
                api_key: window.apiKey,
                employee_id: employeeData ? employeeData.id : null,
                employee_name: employeeData ? employeeData.name : 'غير معروف',
                status: 'new',
                order_code: null,
                created_at: serverTimestamp(),
                processed: false
            };

            try {
                // إخفاء الفورم وعرض Loading
                document.getElementById('orderForm').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                // إرسال لـ Firebase
                const docRef = await addDoc(collection(db, 'orders'), orderData);
                console.log('Order sent with ID:', docRef.id);

                // الانتظار للحصول على كود الطلب من السيستم
                // استمع للتحديثات على الطلب
                const { onSnapshot, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const unsubscribe = onSnapshot(doc(db, 'orders', docRef.id), (docSnapshot) => {
                    const data = docSnapshot.data();
                    
                    if (data.processed && data.order_code) {
                        // إخفاء Loading وعرض رسالة النجاح
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                        
                        // ملء التفاصيل
                        document.getElementById('orderCode').textContent = data.order_code;
                        document.getElementById('orderCustomer').textContent = orderData.customer_name;
                        
                        // عرض رقم الهاتف (مع الثانوي إذا كان موجوداً)
                        const phoneDisplay = orderData.secondary_phone ? 
                            `${orderData.phone_number} - ${orderData.secondary_phone}` : 
                            orderData.phone_number;
                        document.getElementById('orderPhone').textContent = phoneDisplay;
                        
                        document.getElementById('orderFullAddress').textContent = `${orderData.province} - ${orderData.address_details}`;
                        document.getElementById('orderPageName').textContent = orderData.page_name || 'غير محدد';
                        document.getElementById('orderEmployee').textContent = orderData.employee_name || 'غير معروف';
                        document.getElementById('orderShipping').textContent = parseFloat(shipping.toFixed(2));
                        document.getElementById('orderTotal').textContent = parseFloat(grandTotal.toFixed(2));
                        
                        // عرض قائمة المنتجات بتنسيق عربي
                        const productsList = products.map(p => {
                            const total = parseFloat((p.price * p.quantity).toFixed(2));
                            return `${p.name} - ${p.size} - الكمية: ${p.quantity} - السعر: ${total} جنيه`;
                        }).join(' | ');
                        document.getElementById('orderProductsList').textContent = productsList;
                        
                        // إيقاف الاستماع
                        unsubscribe();
                    }
                });
                
                // Timeout بعد 30 ثانية
                setTimeout(() => {
                    if (document.getElementById('loading').style.display !== 'none') {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                        
                        // رسالة واضحة للموظف
                        document.getElementById('orderCode').innerHTML = '<span style="color: #D4AF37; font-size: 14px;">⏳ تم إرسال الطلب بنجاح إلى النظام</span><br><span style="color: #6c757d; font-size: 12px;">سيتم توليد كود الطلب عند معالجته</span>';
                        
                        // ملء التفاصيل
                        document.getElementById('orderCustomer').textContent = orderData.customer_name;
                        
                        // عرض رقم الهاتف (مع الثانوي إذا كان موجوداً)
                        const phoneDisplay = orderData.secondary_phone ? 
                            `${orderData.phone_number} - ${orderData.secondary_phone}` : 
                            orderData.phone_number;
                        document.getElementById('orderPhone').textContent = phoneDisplay;
                        
                        document.getElementById('orderFullAddress').textContent = `${orderData.province} - ${orderData.address_details}`;
                        document.getElementById('orderPageName').textContent = orderData.page_name || 'غير محدد';
                        document.getElementById('orderEmployee').textContent = orderData.employee_name || 'غير معروف';
                        document.getElementById('orderShipping').textContent = parseFloat(shipping.toFixed(2));
                        document.getElementById('orderTotal').textContent = parseFloat(grandTotal.toFixed(2));
                        
                        // عرض قائمة المنتجات
                        const productsList = products.map(p => {
                            const total = parseFloat((p.price * p.quantity).toFixed(2));
                            return `${p.name} - ${p.size} - الكمية: ${p.quantity} - السعر: ${total} جنيه`;
                        }).join(' | ');
                        document.getElementById('orderProductsList').textContent = productsList;
                        
                        unsubscribe();
                    }
                }, 30000);

            } catch (error) {
                console.error('Error adding order:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('orderForm').style.display = 'block';
                document.getElementById('errorMessage').textContent = '❌ حدث خطأ: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        // دالة نسخ تفاصيل الطلب
        function copyOrderDetails(event) {
            const orderCode = document.getElementById('orderCode').textContent;
            const customer = document.getElementById('orderCustomer').textContent;
            const phone = document.getElementById('orderPhone').textContent;
            const fullAddress = document.getElementById('orderFullAddress').textContent;
            const products = document.getElementById('orderProductsList').textContent;
            const shipping = document.getElementById('orderShipping').textContent;
            const total = document.getElementById('orderTotal').textContent;
            const pageName = document.getElementById('orderPageName').textContent;
            const employee = document.getElementById('orderEmployee').textContent;
            
            const text = `تفاصيل الطلب

كود الطلب: ${orderCode}
اسم العميل: ${customer}
رقم الهاتف: ${phone}
العنوان: ${fullAddress}
المنتجات: ${products}
قيمة الشحن: ${shipping} جنيه
المبلغ الإجمالي: ${total} جنيه
اسم الصفحة: ${pageName}
الموظف: ${employee}`;
            
            navigator.clipboard.writeText(text).then(() => {
                // تغيير النص والأيقونة مؤقتاً
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> تم النسخ!';
                btn.style.background = '#43a047';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '#5fb091';
                }, 2000);
            }).catch(err => {
                alert('فشل النسخ: ' + err);
            });
        }

        // Make functions global
        window.calculateTotal = calculateTotal;
        window.copyOrderDetails = copyOrderDetails;
    </script>

    <script>
        // إضافة منتج جديد
        function addProduct() {
            const container = document.getElementById('productsContainer');
            const index = container.children.length;
            
            const productRow = document.createElement('div');
            productRow.className = 'product-row';
            productRow.setAttribute('data-product-index', index);
            productRow.innerHTML = `
                <div class="row align-items-end">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">اسم المنتج *</label>
                        <select class="form-control product-select" required onchange="loadVariants(this)">
                            <option value="">-- اختر المنتج --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">المقاس/الحجم *</label>
                        <select class="form-control variant-select" required onchange="updatePrice(this)">
                            <option value="">-- اختر المقاس --</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">الكمية *</label>
                        <input type="number" class="form-control product-quantity" min="1" value="1" required onchange="calculateTotal()">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">السعر</label>
                        <input type="number" class="form-control product-price" min="0" step="0.01" required readonly>
                    </div>
                    <div class="col-md-1 mb-2">
                        <button type="button" class="btn-remove-product" onclick="removeProduct(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(productRow);
            updateProductSelects(); // تحديث قائمة المنتجات في الصف الجديد
            updateRemoveButtons();
        }

        // حذف منتج
        function removeProduct(button) {
            button.closest('.product-row').remove();
            updateRemoveButtons();
            calculateTotal();
        }

        // تحديث أزرار الحذف
        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.product-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.btn-remove-product');
                if (rows.length > 1) {
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
