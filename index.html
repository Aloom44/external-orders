<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Rumex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .order-card {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .card-header h1 {
            margin: 0;
            font-size: 28px;
        }
        .card-body {
            padding: 30px;
        }
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            padding: 12px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .section-title {
            background: #f8f9fa;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 25px 0 15px 0;
            font-weight: 700;
            color: #667eea;
        }
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            color: white;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .product-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .btn-add-product {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .btn-remove-product {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        .price-summary {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }
        .price-row.total {
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
            border-top: 2px solid #667eea;
            padding-top: 15px;
            margin-top: 10px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .success-message {
            display: none;
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }
        .success-message h2 {
            color: #155724;
            margin-bottom: 15px;
        }
        .order-code {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin: 15px 0;
        }
        .error-message {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            color: #721c24;
            margin: 20px 0;
            display: none;
        }
        .user-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .user-info strong {
            color: #856404;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="order-card">
        <div class="card-header">
            <h1><i class="fas fa-box"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
            <p style="margin: 10px 0 0 0; font-size: 14px;">Rumex - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
        </div>

        <div class="card-body">
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
            <div class="user-info" id="userInfo">
                <i class="fas fa-user-circle" style="font-size: 24px;"></i>
                <strong id="userName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</strong>
            </div>

            <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ -->
            <div class="success-message" id="successMessage">
                <h2><i class="fas fa-check-circle"></i> ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h2>
                <div class="order-details" style="text-align: right; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #152F3E; font-size: 18px;">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:</strong>
                    </div>
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                        <strong>ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨:</strong>
                        <div class="order-code" id="orderCode" style="margin: 5px 0;">---</div>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="orderCustomer">---</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>ğŸ“ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> <span id="orderProvince">---</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</strong> <span id="orderProductsCount">---</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> <span id="orderTotal" style="color: #5fb091ff; font-size: 20px; font-weight: bold;">---</span> Ø¬Ù†ÙŠÙ‡
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="orderPhone">---</span>
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="location.reload()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>

            <!-- ÙÙˆØ±Ù… Ø§Ù„Ø·Ù„Ø¨ -->
            <form id="orderForm">
                <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                <div class="section-title">
                    <i class="fas fa-user"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
                        <input type="tel" class="form-control" id="phoneNumber" pattern="[0-9]{11}" placeholder="01xxxxxxxxx" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© *</label>
                        <select class="form-select" id="province" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                            <option value="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                            <option value="Ø§Ù„Ø¬ÙŠØ²Ø©">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
                            <option value="Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©">Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
                            <option value="Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©">Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
                            <option value="Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
                            <option value="Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©">Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
                            <option value="Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©">Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
                            <option value="Ø§Ù„Ø¨Ø­ÙŠØ±Ø©">Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
                            <option value="Ø§Ù„ØºØ±Ø¨ÙŠØ©">Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø«Ø§Ù†ÙˆÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="tel" class="form-control" id="secondaryPhone" pattern="[0-9]{11}">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ *</label>
                    <textarea class="form-control" id="addressDetails" rows="2" required></textarea>
                </div>

                <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
                <div class="section-title">
                    <i class="fas fa-shopping-cart"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </div>

                <div id="productsContainer">
                    <div class="product-row" data-product-index="0">
                        <div class="row align-items-end">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
                                <select class="form-control product-select" required onchange="loadVariants(this)">
                                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ --</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Ø§Ù„Ù…Ù‚Ø§Ø³/Ø§Ù„Ø­Ø¬Ù… *</label>
                                <select class="form-control variant-select" required onchange="updatePrice(this)">
                                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³ --</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
                                <input type="number" class="form-control product-quantity" min="1" value="1" required onchange="calculateTotal()">
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">Ø§Ù„Ø³Ø¹Ø±</label>
                                <input type="number" class="form-control product-price" min="0" step="0.01" required readonly>
                            </div>
                            <div class="col-md-1 mb-2">
                                <button type="button" class="btn-remove-product" onclick="removeProduct(this)" style="display:none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-add-product" onclick="addProduct()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¢Ø®Ø±
                </button>

                <!-- Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª -->
                <div class="section-title">
                    <i class="fas fa-calculator"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†</label>
                        <input type="number" class="form-control" id="shippingCost" min="0" step="0.01" value="0">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø§Ù„Ø®ØµÙ…</label>
                        <input type="number" class="form-control" id="discount" min="0" step="0.01" value="0">
                    </div>
                </div>

                <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± -->
                <div class="price-summary">
                    <div class="price-row">
                        <span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span>
                        <strong><span id="productsTotal">0.00</span> Ø¬Ù†ÙŠÙ‡</strong>
                    </div>
                    <div class="price-row">
                        <span>Ø§Ù„Ø´Ø­Ù†:</span>
                        <strong><span id="shippingTotal">0.00</span> Ø¬Ù†ÙŠÙ‡</strong>
                    </div>
                    <div class="price-row">
                        <span>Ø§Ù„Ø®ØµÙ…:</span>
                        <strong style="color: #dc3545;">-<span id="discountTotal">0.00</span> Ø¬Ù†ÙŠÙ‡</strong>
                    </div>
                    <div class="price-row total">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                        <span id="grandTotal">0.00 Ø¬Ù†ÙŠÙ‡</span>
                    </div>
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                <div class="section-title">
                    <i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø©</label>
                        <input type="text" class="form-control" id="pageName" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙƒØªÙˆØ± Ù†Ø³Ø±ÙŠÙ†">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ø¹Ù…ÙŠÙ„ VIP</label>
                        <select class="form-select" id="isVip">
                            <option value="false">Ù„Ø§</option>
                            <option value="true">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-control" id="notes" rows="3" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                </div>

                <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
                <button type="submit" class="btn-submit">
                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                </button>

                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</span>
                    </div>
                    <p class="mt-2">Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCd3epuBRvwtz6w-12C3uUcTZNaPeklD-I",
            authDomain: "rumex-orders.firebaseapp.com",
            projectId: "rumex-orders",
            storageBucket: "rumex-orders.firebasestorage.app",
            messagingSenderId: "575319007618",
            appId: "1:575319007618:web:b0efe0ddf706722cf66f9b",
            measurementId: "G-8LDPSCNRC0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Get API Key from URL
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('key');
        
        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        let productsData = [];

        if (!apiKey) {
            document.getElementById('errorMessage').textContent = 'âš ï¸ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ùƒ.';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('orderForm').style.display = 'none';
        } else {
            document.getElementById('userName').textContent = `Ù…Ø³ØªØ®Ø¯Ù…: ${apiKey.substring(0, 8)}...`;
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù€ API
            loadProducts();
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù€ API
        async function loadProducts() {
            try {
                const response = await fetch('http://localhost:8000/api/external/products/');
                const data = await response.json();
                
                if (data.success) {
                    productsData = data.products;
                    updateProductSelects();
                } else {
                    console.error('Error loading products:', data.error);
                }
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        function updateProductSelects() {
            document.querySelectorAll('.product-select').forEach(select => {
                select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ --</option>';
                productsData.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    option.dataset.variants = JSON.stringify(product.variants);
                    select.appendChild(option);
                });
            });
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬
        window.loadVariants = function(selectElement) {
            const row = selectElement.closest('.product-row');
            const variantSelect = row.querySelector('.variant-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            variantSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³ --</option>';
            
            if (selectedOption.dataset.variants) {
                const variants = JSON.parse(selectedOption.dataset.variants);
                variants.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant.id;
                    option.textContent = variant.display_name;
                    option.dataset.price = variant.price;
                    option.dataset.stock = variant.quantity;
                    variantSelect.appendChild(option);
                });
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø¹Ø±
            row.querySelector('.product-price').value = '';
            calculateTotal();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØºÙŠØ±
        window.updatePrice = function(selectElement) {
            const row = selectElement.closest('.product-row');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            if (selectedOption.dataset.price) {
                row.querySelector('.product-price').value = selectedOption.dataset.price;
                calculateTotal();
            }
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        function calculateTotal() {
            let productsTotal = 0;
            document.querySelectorAll('.product-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.product-price').value) || 0;
                productsTotal += quantity * price;
            });

            const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const grandTotal = productsTotal + shipping - discount;

            document.getElementById('productsTotal').textContent = productsTotal.toFixed(2);
            document.getElementById('shippingTotal').textContent = shipping.toFixed(2);
            document.getElementById('discountTotal').textContent = discount.toFixed(2);
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡';
        }

        // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('product-quantity') || 
                e.target.classList.contains('product-price') ||
                e.target.id === 'shippingCost' ||
                e.target.id === 'discount') {
                calculateTotal();
            }
        });

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            const products = [];
            let productsTotal = 0;
            
            document.querySelectorAll('.product-row').forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const variantSelect = row.querySelector('.variant-select');
                const productName = productSelect.options[productSelect.selectedIndex].text;
                const variantName = variantSelect.options[variantSelect.selectedIndex].text;
                const quantity = parseInt(row.querySelector('.product-quantity').value);
                const price = parseFloat(row.querySelector('.product-price').value);

                products.push({
                    product_id: productSelect.value,
                    variant_id: variantSelect.value,
                    name: productName,
                    size: variantName,
                    quantity: quantity,
                    price: price
                });
                
                productsTotal += quantity * price;
            });

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const grandTotal = productsTotal + shipping - discount;

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
            const orderData = {
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                customer_name: document.getElementById('customerName').value,
                phone_number: document.getElementById('phoneNumber').value,
                secondary_phone: document.getElementById('secondaryPhone').value || '',
                province: document.getElementById('province').value,
                address_details: document.getElementById('addressDetails').value,
                
                // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                products: products,
                
                // Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                total_products: productsTotal,
                shipping_cost: shipping,
                discount: discount,
                total_amount: grandTotal,
                
                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                notes: document.getElementById('notes').value || '',
                page_name: document.getElementById('pageName').value || '',
                is_vip: document.getElementById('isVip').value === 'true',
                
                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                api_key: apiKey,
                status: 'pending',
                order_code: null,
                created_at: serverTimestamp(),
                processed: false
            };

            try {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙˆØ±Ù… ÙˆØ¹Ø±Ø¶ Loading
                document.getElementById('orderForm').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ Firebase
                const docRef = await addDoc(collection(db, 'orders'), orderData);
                console.log('Order sent with ID:', docRef.id);

                // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ³ØªÙ…
                // Ø§Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨
                const { onSnapshot, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const unsubscribe = onSnapshot(doc(db, 'orders', docRef.id), (docSnapshot) => {
                    const data = docSnapshot.data();
                    
                    if (data.processed && data.order_code) {
                        // Ø¥Ø®ÙØ§Ø¡ Loading ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                        
                        // Ù…Ù„Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                        document.getElementById('orderCode').textContent = data.order_code;
                        document.getElementById('orderCustomer').textContent = orderData.customer_name;
                        document.getElementById('orderProvince').textContent = orderData.province;
                        document.getElementById('orderProductsCount').textContent = products.length;
                        document.getElementById('orderTotal').textContent = grandTotal.toFixed(2);
                        document.getElementById('orderPhone').textContent = orderData.phone_number;
                        
                        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
                        unsubscribe();
                    }
                });
                
                // Timeout Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => {
                    if (document.getElementById('loading').style.display !== 'none') {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                        document.getElementById('orderCode').textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ - ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
                        
                        // Ù…Ù„Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                        document.getElementById('orderCustomer').textContent = orderData.customer_name;
                        document.getElementById('orderProvince').textContent = orderData.province;
                        document.getElementById('orderProductsCount').textContent = products.length;
                        document.getElementById('orderTotal').textContent = grandTotal.toFixed(2);
                        document.getElementById('orderPhone').textContent = orderData.phone_number;
                        
                        unsubscribe();
                    }
                }, 30000);

            } catch (error) {
                console.error('Error adding order:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('orderForm').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        // Make functions global
        window.calculateTotal = calculateTotal;
    </script>

    <script>
        // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
        function addProduct() {
            const container = document.getElementById('productsContainer');
            const index = container.children.length;
            
            const productRow = document.createElement('div');
            productRow.className = 'product-row';
            productRow.setAttribute('data-product-index', index);
            productRow.innerHTML = `
                <div class="row align-items-end">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
                        <select class="form-control product-select" required onchange="loadVariants(this)">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Ø§Ù„Ù…Ù‚Ø§Ø³/Ø§Ù„Ø­Ø¬Ù… *</label>
                        <select class="form-control variant-select" required onchange="updatePrice(this)">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³ --</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
                        <input type="number" class="form-control product-quantity" min="1" value="1" required onchange="calculateTotal()">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">Ø§Ù„Ø³Ø¹Ø±</label>
                        <input type="number" class="form-control product-price" min="0" step="0.01" required readonly>
                    </div>
                    <div class="col-md-1 mb-2">
                        <button type="button" class="btn-remove-product" onclick="removeProduct(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(productRow);
            updateProductSelects(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            updateRemoveButtons();
        }

        // Ø­Ø°Ù Ù…Ù†ØªØ¬
        function removeProduct(button) {
            button.closest('.product-row').remove();
            updateRemoveButtons();
            calculateTotal();
        }

        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.product-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.btn-remove-product');
                if (rows.length > 1) {
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
